<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connexion ValidÃ©e</title>
  <link rel="stylesheet" href="../page-css/style-connexion.css">
</head>
<body>
  <div class="container">
    <h1>âœ… Connexion ValidÃ©e ! Bienvenue ðŸŽ‰</h1>
    <p class="subtitle">On est super contents de te voir ici ðŸ˜Ž</p>
    <div class="fun-zone">
      <p>âœ¨ Tu as officiellement rejoint le club des gens incroyables âœ¨</p>
      <p>ðŸ¥³ Profite de ta session, elle est plus fraÃ®che quâ€™un cafÃ© du matin â˜•</p>
      <p>ðŸ’¡ Astuce du jour : sourire augmente ton style de +10 points !</p>
    </div>
    <button onclick="window.location.href='../index.html'" class="btn">Retour Ã  lâ€™accueil</button>
  </div>

  <!-- Canvas pour les confettis -->
  <canvas id="confetti-canvas"></canvas>

  <!-- Script confettis -->
  <script src="../page-js/confetti.js"></script>

<script>
        const AUTH_TOKEN_KEY = 'authToken'; 
        const SERVER_URL = "http://172.29.18.249:2864";

        const checkUserStatus = async () => {
            const token = localStorage.getItem(AUTH_TOKEN_KEY);
            const statusEl = document.getElementById('status-message');

            // 1. Si pas de token, on redirige immÃ©diatement (cas de la navigation privÃ©e)
            if (!token) {
                statusEl.textContent = "âŒ Session expirÃ©e ou non dÃ©marrÃ©e. Redirection vers le login.";
                setTimeout(() => {
                    window.location.href = "../index.html"; // Redirigez vers votre page de login
                }, 1000);
                return;
            }

            try {
                // 2. VÃ©rification du token auprÃ¨s du back-end
                const response = await fetch(`${SERVER_URL}/api/user-status`, {
                    method: "GET",
                    headers: {
                        'Authorization': `Bearer ${token}` 
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    // Token valide, afficher les infos
                    statusEl.textContent = `âœ… Session ValidÃ©e. Bienvenue, utilisateur ${data.userId} !`;
                } else {
                    // 3. Token invalide/expirÃ© (401/403), on dÃ©connecte
                    statusEl.textContent = `âŒ Authentification Ã©chouÃ©e: ${data.error}. DÃ©connexion.`;
                    localStorage.removeItem(AUTH_TOKEN_KEY);
                    setTimeout(() => {
                        window.location.href = "../index.html";
                    }, 1000);
                }
            } catch (error) {
                statusEl.textContent = "âš ï¸ Erreur de connexion au serveur. DÃ©connexion par sÃ©curitÃ©.";
                console.error("Erreur Fetch:", error);
                localStorage.removeItem(AUTH_TOKEN_KEY);
                setTimeout(() => {
                    window.location.href = "../index.html";
                }, 1000);
            }
        };

        const logout = () => {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            localStorage.removeItem("user");
            window.location.href = "../index.html";
        };

        // Lancer la vÃ©rification au chargement de la page
        checkUserStatus();
    </script>

</body>
</html>
